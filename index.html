<!-- 
  Dog Health Tracker Application - REAL-TIME ANALYSIS ONLY
  Built using HTML, Tailwind CSS, JavaScript, and Gemini API.
  NOTE: This version is configured to use the API key automatically provided by the execution environment.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pooch Monitor - Real-Time</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Style for photo preview placeholder */
        #photoPreview {
            background-color: #e2e8f0; /* Slate 200 */
            background-image: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b; /* Slate 500 */
            font-size: 0.875rem;
            text-align: center;
        }
        #photoPreview::after {
            content: "Photo Preview";
        }
        #photoPreview:not(.hidden)::after {
            content: ""; /* Hide text when image is loaded */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6">
    <div id="app" class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 md:p-8 space-y-8">
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">Pooch Monitor üêæ</h1>
            <p class="text-gray-500 font-semibold">Real-Time Analysis Only (No History Stored)</p>
        </header>

        <!-- Alert Message Box -->
        <div id="alertContainer" class="hidden">
            <!-- Alert content will be injected here -->
        </div>

        <!-- Submission Form -->
        <section class="border border-gray-200 rounded-lg p-5 space-y-5">
            <h2 class="text-2xl font-semibold text-gray-700">New Health Check</h2>
            <form id="recordForm" class="space-y-4">
                
                <!-- Date/Time & Status Display -->
                <div class="flex flex-col sm:flex-row sm:space-x-4">
                    <div class="w-full sm:w-1/2">
                        <label class="block text-sm font-medium text-gray-700">Current Date/Time</label>
                        <p id="dateTimeDisplay" class="mt-1 p-2 bg-gray-100 rounded-md text-gray-600 font-mono"></p>
                    </div>
                    <!-- Status Display (Updated to show No Storage) -->
                    <div class="w-full sm:w-1/2 mt-4 sm:mt-0">
                        <label class="block text-sm font-medium text-gray-700">Storage Status</label>
                        <p id="storageStatusDisplay" class="mt-1 p-2 bg-gray-100 rounded-md text-sm text-gray-500 font-mono">No Local or Cloud Storage</p>
                    </div>
                </div>

                <!-- Poop Photo Upload -->
                <div>
                    <label for="poopPhoto" class="block text-sm font-medium text-gray-700 mb-2">
                        Upload Poop Photo (Camera Ready)
                    </label>
                    <input type="file" id="poopPhoto" accept="image/jpeg,image/png" capture="camera" required
                           class="w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-full file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700
                                  hover:file:bg-blue-100"/>
                </div>
                <div id="photoPreview" class="hidden w-32 h-32 mt-2 object-cover rounded-lg border-2 border-gray-200"></div>

                <!-- Food Eaten Notes -->
                <div>
                    <label for="foodNotes" class="block text-sm font-medium text-gray-700">
                        Food Eaten (Last 12 hours)
                    </label>
                    <textarea id="foodNotes" rows="2" placeholder="e.g., Chicken and rice, 1 cup kibble (Brand X)"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <!-- Symptoms Notes -->
                <div>
                    <label for="symptomsNotes" class="block text-sm font-medium text-gray-700">
                        Any Symptoms? (Energy, Thirst, Vomiting)
                    </label>
                    <textarea id="symptomsNotes" rows="2" placeholder="e.g., Seems lethargic, drinking more water today"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitButton"
                        class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white 
                               bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 
                               transition duration-150 ease-in-out disabled:bg-gray-400">
                    Analyze in Real-Time
                </button>
                <div id="loadingIndicator" class="hidden text-center text-blue-600 font-semibold mt-2">
                    Analyzing photo and consulting the AI...
                </div>
            </form>
        </section>

        <!-- The history section has been removed -->

    </div>

    <!-- Modals for LLM Response and Errors -->
    <div id="modalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-lg p-6 w-full max-w-lg shadow-2xl space-y-4">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800">AI Analysis Complete</h3>
            <div id="modalBody" class="text-gray-600 max-h-96 overflow-y-auto"></div>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        
        // --- LLM API Configuration ---
        // The API key is set to an empty string and is automatically injected by the environment at runtime.
        const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; 

        // --- Utility Functions ---

        /** Creates an immediate status alert based on the single analysis result. */
        function displayImmediateAlert(status) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            alertContainer.classList.add('hidden');

            let alertMessage = null;
            let alertType = 'info';

            switch (status) {
                case 'VET_URGENT':
                    alertMessage = "üî¥ **VET URGENT:** The analysis suggests severe abnormalities. **Please contact your veterinarian immediately.** Do not wait.";
                    alertType = 'danger';
                    break;
                case 'MONITOR':
                    alertMessage = "‚ö†Ô∏è **MONITOR STATUS:** The analysis suggests a change. **Monitor your dog closely** for the next 24 hours. Consult a vet if symptoms worsen.";
                    alertType = 'warning';
                    break;
                case 'NORMAL':
                    alertMessage = "üü¢ **NORMAL:** The analysis suggests healthy stool and no immediate concerns. Keep up the good work!";
                    alertType = 'success';
                    break;
                default:
                    alertMessage = "üîµ **ANALYSIS COMPLETE:** The AI has provided its findings. Review the details below.";
                    alertType = 'info';
            }

            const colorMap = {
                danger: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400' },
                warning: { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-400' },
                success: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400' },
                info: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400' }
            };
            const colors = colorMap[alertType];

            alertContainer.innerHTML = `
                <div class="${colors.bg} ${colors.text} border-l-4 ${colors.border} p-4 rounded-lg shadow-md">
                    <p class="font-bold">${alertMessage.split('**')[1] || 'Alert'}</p>
                    <p class="text-sm mt-1">${alertMessage.replace(/<[^>]*>?/gm, '').replace(/\*\*/g, '').split('**')[2] || 'Review the details for more information.'}</p>
                </div>
            `;
            alertContainer.classList.remove('hidden');
        }

        /** Shows the custom modal with content. */
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
        }

        window.closeModal = function() {
            document.getElementById('modalOverlay').classList.remove('flex');
            document.getElementById('modalOverlay').classList.add('hidden');
        }
        
        // --- LLM Interaction Functions ---

        /** Generates the payload for the Gemini API. */
        function generateApiPayload(base64Image, foodNotes, symptomsNotes) {
            const systemPrompt = `You are an expert veterinary assistant specializing in canine stool analysis. 
                Analyze the provided photo of dog poop along with the owner's notes.
                Provide a structured, three-part response in plain text.
                
                1. ANALYSIS: Describe the visible characteristics (consistency, color, content).
                2. ADVICE: Provide non-diagnostic, general wellness advice based on the photo and notes.
                3. STATUS: Provide a single, all-caps keyword on a new line: VET_URGENT, MONITOR, or NORMAL.
                   - VET_URGENT: Use for severe abnormalities (bright red blood, black/tarry, excessive mucus, extreme liquid/watery).
                   - MONITOR: Use for mild or concerning changes (slightly soft, unusual color not severe, minor straining).
                   - NORMAL: Use for healthy-looking stool.
                
                Owner's Notes: Food: ${foodNotes}. Symptoms: ${symptomsNotes}.
            `;

            return {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Analyze this dog stool photo based on the notes below." },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg", // Assume JPEG/PNG for camera output
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
        }

        /** Calls the Gemini API with exponential backoff. */
        async function callGeminiApi(payload, retries = 3, delay = 1000) {
            const url = LLM_API_URL + apiKey;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        if (i < retries - 1) {
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }
                        throw new Error("API rate limit exceeded after all retries.");
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API request failed with status: ${response.status}. Message: ${errorBody.error.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!text) {
                        throw new Error("Received empty or malformed response from LLM.");
                    }
                    
                    return text;

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    if (i === retries - 1) throw error;
                    // Continue loop to retry
                }
            }
            throw new Error("Failed to call LLM API after all retries.");
        }


        // --- Form Submission Logic ---

        document.getElementById('recordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const photoInput = document.getElementById('poopPhoto');
            const foodNotes = document.getElementById('foodNotes').value.trim();
            const symptomsNotes = document.getElementById('symptomsNotes').value.trim();
            const submitButton = document.getElementById('submitButton');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!photoInput.files[0]) {
                showModal("Error", "<p>Please upload a photo of the dog poop.</p>");
                return;
            }
            
            // NOTE: The check for YOUR_GEMINI_API_KEY is removed, as we rely on the environment.

            submitButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            document.getElementById('alertContainer').classList.add('hidden'); // Clear previous alert

            try {
                const file = photoInput.files[0];
                const reader = new FileReader();

                reader.onloadend = async function() {
                    try {
                        const base64Image = reader.result.split(',')[1]; 

                        // 1. Call LLM for analysis
                        const payload = generateApiPayload(base64Image, foodNotes, symptomsNotes);
                        const analysisText = await callGeminiApi(payload);

                        // 2. Extract Status from Analysis
                        const lines = analysisText.split('\n');
                        const statusLine = lines.find(line => 
                            line.includes('VET_URGENT') || 
                            line.includes('MONITOR') || 
                            line.includes('NORMAL')
                        ) || 'NORMAL';
                        const status = statusLine.trim().toUpperCase();
                        
                        // 3. Show the Analysis Modal
                        showModal("AI Analysis", analysisText.replace(/\n/g, '<br>'));
                        
                        // 4. Display the immediate alert
                        displayImmediateAlert(status);
                        
                        // 5. Clear the form (optional)
                        document.getElementById('recordForm').reset();
                        document.getElementById('photoPreview').classList.add('hidden');

                    } catch (error) {
                        console.error("Error during analysis:", error);
                        showModal("Analysis Error", `<p class="text-red-600">Failed to complete the analysis.</p><p>Details: ${error.message}</p>`);
                        displayImmediateAlert('ERROR');
                    } finally {
                        submitButton.disabled = false;
                        loadingIndicator.classList.add('hidden');
                    }
                }
                reader.readAsDataURL(file);

            } catch (error) {
                console.error("File reading error:", error);
                submitButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Initial Load Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set initial date/time
            const updateDateTime = () => {
                document.getElementById('dateTimeDisplay').textContent = new Date().toLocaleString();
            };
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second

            // Photo preview logic
            document.getElementById('poopPhoto').addEventListener('change', function(event) {
                const preview = document.getElementById('photoPreview');
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.style.backgroundImage = `url('${e.target.result}')`;
                        preview.classList.remove('hidden');
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.classList.add('hidden');
                    preview.style.backgroundImage = 'none';
                }
            });
        });
    </script>
</body>
</html>
