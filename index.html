<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pooch Monitor: Health Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .spinner { border-top-color: #3b82f6; -webkit-animation: spin 1s ease-in-out infinite; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables will be populated here
        window.firebase = {};

        // --- Global Constants from Environment (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = "" // API key is provided by the canvas environment

        setLogLevel('Debug');

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    document.getElementById('analysis-status').textContent = "Error: Firebase configuration is missing.";
                    return;
                }

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                window.firebase.db = db;
                window.firebase.auth = auth;
                window.firebase.appId = appId;
                
                let userId = null;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with UID:", userId);
                        window.firebase.userId = userId;
                        window.setupListeners();
                    } else {
                        // Attempt to authenticate
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        }

        /**
         * Converts a File object to a Base64 string for the API.
         * @param {File} file 
         * @returns {Promise<string>} Base64 data string
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Generates the API call payload.
         * @param {string} base64Image
         * @param {string} mimeType
         * @param {string} prompt
         * @returns {Object}
         */
        function generateApiPayload(base64Image, mimeType, prompt) {
            const systemPrompt = "You are a specialized Veterinary Assistant AI. Analyze the provided image of dog feces and the accompanying health notes. Provide a brief (2-3 sentence) summary of your findings on color, consistency, and presence of anomalies. Conclude your response with a clear status indicator. Only use one of these three status markers at the very start of your reply: 'STATUS: NORMAL', 'STATUS: MONITOR', or 'STATUS: VET_URGENT'. Do not add any extra text before the status. E.g., 'STATUS: NORMAL. The feces appear...', 'STATUS: VET_URGENT. The photo suggests...'.";

            return {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
        }

        /**
         * Calls the Gemini API for analysis.
         * @param {Object} payload 
         * @returns {Promise<{text: string, status: string}>}
         */
        async function callGeminiApi(payload) {
            let attempt = 0;
            const maxRetries = 5;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis failed to produce text.";
                    
                    // Simple parsing for the STATUS marker
                    let status = "UNKNOWN";
                    const statusMatch = text.match(/STATUS: (NORMAL|MONITOR|VET_URGENT)/);
                    if (statusMatch) {
                        status = statusMatch[1];
                    }

                    return { text: text.replace(/STATUS: (NORMAL|MONITOR|VET_URGENT)\.?\s*/, '').trim(), status };

                } catch (error) {
                    attempt++;
                    console.error(`Attempt ${attempt} failed:`, error);
                    if (attempt >= maxRetries) {
                        throw new Error("Failed to connect to AI after multiple retries.");
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }
        
        /**
         * Renders the history from Firestore and checks for alerts.
         * @param {Array} records 
         */
        function renderHistory(records) {
            const historyContainer = document.getElementById('history-records');
            const alertBox = document.getElementById('vet-alert');
            historyContainer.innerHTML = '';
            alertBox.classList.add('hidden'); // Reset alert

            if (records.length > 0) {
                // Check for alert if we have at least two records
                if (records.length >= 2) {
                    const currentStatus = records[0].analysisStatus;
                    const previousStatus = records[1].analysisStatus;

                    if (currentStatus === 'VET_URGENT' || (currentStatus === 'MONITOR' && previousStatus === 'NORMAL')) {
                        alertBox.classList.remove('hidden');
                        alertBox.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <svg class="w-6 h-6 text-red-700" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                <p class="font-bold text-red-800">Alert: Status Change Detected!</p>
                            </div>
                            <p class="text-sm mt-1">The current entry shows a status of <span class="font-semibold">${currentStatus}</span>, which is a change from the previous <span class="font-semibold">${previousStatus}</span>. Please contact your veterinarian for professional guidance.</p>
                        `;
                    }
                }

                records.forEach((record, index) => {
                    let statusColor = 'bg-gray-200 text-gray-800';
                    let statusIcon = 'ⓘ';
                    if (record.analysisStatus === 'NORMAL') {
                        statusColor = 'bg-green-100 text-green-700';
                        statusIcon = '✓';
                    } else if (record.analysisStatus === 'MONITOR') {
                        statusColor = 'bg-yellow-100 text-yellow-700';
                        statusIcon = '!';
                    } else if (record.analysisStatus === 'VET_URGENT') {
                        statusColor = 'bg-red-100 text-red-700';
                        statusIcon = '🚨';
                    }

                    const card = `
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${record.analysisStatus === 'VET_URGENT' ? 'border-red-500' : record.analysisStatus === 'MONITOR' ? 'border-yellow-500' : 'border-blue-500'} mb-4">
                            <div class="flex justify-between items-start mb-2 border-b pb-2">
                                <h3 class="font-bold text-lg text-blue-800">${new Date(record.timestamp).toLocaleString()}</h3>
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor} flex items-center space-x-1">
                                    <span>${statusIcon}</span>
                                    <span>${record.analysisStatus || 'UNKNOWN'}</span>
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 text-sm">
                                <div>
                                    <p class="font-semibold text-gray-600">Food Eaten:</p>
                                    <p class="text-gray-700 mb-2">${record.foodNotes || 'N/A'}</p>
                                    <p class="font-semibold text-gray-600">Dog Symptoms:</p>
                                    <p class="text-gray-700">${record.symptomsNotes || 'N/A'}</p>
                                </div>
                                <div class="mt-4 md:mt-0">
                                    <p class="font-semibold text-gray-600">AI Analysis:</p>
                                    <p class="text-gray-700 bg-gray-50 p-3 rounded-md italic">${record.analysisResult || 'No result available.'}</p>
                                </div>
                            </div>
                            <p class="text-xs text-right text-gray-400 mt-2">Record ID: ${record.id.substring(0, 8)}</p>
                        </div>
                    `;
                    historyContainer.innerHTML += card;
                });
            } else {
                historyContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No records found. Submit your first analysis above!</p>';
            }
        }

        /**
         * Sets up the real-time listener for Firestore history.
         */
        window.setupListeners = function() {
            const db = window.firebase.db;
            const userId = window.firebase.userId;
            const appId = window.firebase.appId;

            if (!db || !userId) {
                console.error("Firebase not ready or User ID missing for listeners.");
                return;
            }

            // Path for private data: /artifacts/{appId}/users/{userId}/{collectionName}
            const collectionPath = `artifacts/${appId}/users/${userId}/poop_records`;
            const q = collection(db, collectionPath);

            // Fetch and sort locally as firestore's orderBy requires indices which can lead to errors.
            // We fetch the entire collection (or use a large limit) and sort in JS.
            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp descending
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                renderHistory(records);
            }, (error) => {
                console.error("Error listening to history:", error);
                document.getElementById('analysis-status').textContent = `Error loading history: ${error.message}`;
            });
        }

        /**
         * Handles the form submission.
         */
        window.submitAnalysis = async function() {
            const statusDiv = document.getElementById('analysis-status');
            const form = document.getElementById('analysis-form');
            const photoInput = document.getElementById('photo-input');
            const submitButton = document.getElementById('submit-button');
            const spinner = document.getElementById('spinner');

            if (!window.firebase.db || !window.firebase.userId) {
                statusDiv.textContent = "Error: Authentication not complete. Please wait a moment and try again.";
                statusDiv.className = "text-red-600 mt-4";
                return;
            }

            const photoFile = photoInput.files[0];
            const foodNotes = document.getElementById('food-notes').value;
            const symptomsNotes = document.getElementById('symptoms-notes').value;
            const timestamp = new Date().toISOString();

            if (!photoFile) {
                statusDiv.textContent = "Please take or select a photo of the sample.";
                statusDiv.className = "text-yellow-600 mt-4";
                return;
            }

            // UI feedback
            statusDiv.textContent = "Analysis in progress. This may take a few seconds...";
            statusDiv.className = "text-blue-600 mt-4";
            submitButton.disabled = true;
            spinner.classList.remove('hidden');

            try {
                // 1. Convert image to Base64
                const base64Data = await fileToBase64(photoFile);
                const mimeType = photoFile.type;

                // 2. Prepare prompt
                const prompt = `Analyze this image of dog feces.
                Date/Time: ${new Date(timestamp).toLocaleString()}
                Food Notes: ${foodNotes || 'None provided.'}
                Dog Symptoms: ${symptomsNotes || 'None provided.'}
                Provide a professional, concise assessment (2-3 sentences) followed by the mandatory status marker (STATUS: NORMAL, MONITOR, or VET_URGENT).`;

                // 3. Call LLM API
                const payload = generateApiPayload(base64Data, mimeType, prompt);
                const analysisResult = await callGeminiApi(payload);

                // 4. Save result to Firestore
                const db = window.firebase.db;
                const userId = window.firebase.userId;
                const appId = window.firebase.appId;
                const collectionPath = `artifacts/${appId}/users/${userId}/poop_records`;

                await addDoc(collection(db, collectionPath), {
                    timestamp: timestamp,
                    foodNotes: foodNotes,
                    symptomsNotes: symptomsNotes,
                    analysisResult: analysisResult.text,
                    analysisStatus: analysisResult.status,
                });

                // 5. Success
                statusDiv.textContent = `Analysis complete! Status: ${analysisResult.status}. Record saved.`;
                statusDiv.className = "text-green-600 mt-4";
                form.reset(); // Clear form after successful submission

            } catch (error) {
                console.error("Submission failed:", error);
                statusDiv.textContent = `Error during analysis or saving: ${error.message}`;
                statusDiv.className = "text-red-600 mt-4";
            } finally {
                submitButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Initialize Firebase on window load
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="text-center mb-10 pt-4">
            <h1 class="text-4xl font-extrabold text-blue-900 tracking-tight">Pooch Monitor</h1>
            <p class="mt-2 text-xl text-gray-600">Digital Health Log for Your Best Friend</p>
            <p class="text-xs text-gray-400 mt-1">User ID: <span id="user-id-display">Loading...</span></p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: New Entry Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl h-fit sticky top-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">New Poop Log Entry</h2>

                <form id="analysis-form" onsubmit="event.preventDefault(); submitAnalysis();">
                    
                    <!-- Auto-Populated Date/Time -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Entry Timestamp</label>
                        <p id="current-timestamp" class="text-lg font-semibold text-blue-600"></p>
                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                document.getElementById('current-timestamp').textContent = new Date().toLocaleString();
                                // Update every minute
                                setInterval(() => {
                                    document.getElementById('current-timestamp').textContent = new Date().toLocaleString();
                                }, 60000);
                            });
                        </script>
                    </div>

                    <!-- Photo Input (Camera/File) -->
                    <div class="mb-6">
                        <label for="photo-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Photo (Use Camera or Upload)
                        </label>
                        <input type="file" id="photo-input" accept="image/*" capture="camera" required
                                class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Food Eaten Notes -->
                    <div class="mb-6">
                        <label for="food-notes" class="block text-sm font-medium text-gray-700 mb-1">
                            Food Eaten (Past 12h)
                        </label>
                        <textarea id="food-notes" rows="3" placeholder="e.g., Brand X kibble, half carrot, new treat Y."
                            class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500 resize-none"></textarea>
                    </div>

                    <!-- Symptoms Notes -->
                    <div class="mb-6">
                        <label for="symptoms-notes" class="block text-sm font-medium text-gray-700 mb-1">
                            Dog Symptoms (e.g., Energy, Thirst, Vomiting)
                        </label>
                        <textarea id="symptoms-notes" rows="3" placeholder="e.g., Slightly lethargic, drinking more water."
                            class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500 resize-none"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-button"
                            class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50">
                        Analyze & Save Entry
                        <div id="spinner" class="spinner h-5 w-5 border-4 border-opacity-50 rounded-full hidden ml-3"></div>
                    </button>
                    
                    <!-- Status Message -->
                    <div id="analysis-status" class="mt-4 text-center text-sm font-medium"></div>
                </form>
            </div>

            <!-- Right Column: History & Alerts -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Health History & Alerts</h2>
                
                <!-- Vet Alert Box -->
                <div id="vet-alert" class="hidden bg-red-200 border border-red-400 text-red-700 p-4 rounded-xl mb-6 shadow-md" role="alert">
                    <!-- Alert content injected by JS -->
                </div>

                <!-- History Records -->
                <div id="history-records" class="custom-scrollbar max-h-[80vh] overflow-y-auto">
                    <p class="text-center text-gray-500 p-8">Loading history...</p>
                </div>
            </div>

        </div>
    </div>
    <script>
        // Update User ID Display after Auth
        window.addEventListener('load', () => {
            const authInterval = setInterval(() => {
                const userId = window.firebase && window.firebase.userId;
                if (userId) {
                    document.getElementById('user-id-display').textContent = userId;
                    clearInterval(authInterval);
                }
            }, 500);
        });
    </script>
</body>
</html>
